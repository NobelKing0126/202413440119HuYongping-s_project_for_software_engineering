{% extends "base.html" %}

{% block title %}{{ 'ç¼–è¾‘ä»»åŠ¡' if action == 'edit' else 'æ–°å»ºä»»åŠ¡' }} - æ ¡å›­å¾…åŠæ¸…å•{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi {{ 'bi-pencil' if action == 'edit' else 'bi-plus-circle' }}"></i>
                    {{ 'ç¼–è¾‘ä»»åŠ¡' if action == 'edit' else 'æ–°å»ºä»»åŠ¡' }}
                </h5>
            </div>
            <div class="card-body p-4">
                <form method="POST" action="{{ url_for('task.edit_task', task_id=task.id) if action == 'edit' else url_for('task.create_task') }}">
                    <!-- ä»»åŠ¡æ ‡é¢˜ -->
                    <div class="mb-3">
                        <label for="title" class="form-label">
                            ä»»åŠ¡æ ‡é¢˜ <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="title" name="title" 
                               value="{{ task.title if task else title|default('') }}" 
                               required maxlength="50" placeholder="è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜ï¼ˆæœ€å¤š50ä¸ªå­—ç¬¦ï¼‰">
                        <div class="form-text">
                            <span id="titleCount">0</span>/50 ä¸ªå­—ç¬¦
                        </div>
                    </div>
                    
                    <!-- ä»»åŠ¡æè¿° -->
                    <div class="mb-3">
                        <label for="description" class="form-label">ä»»åŠ¡æè¿°</label>
                        <textarea class="form-control" id="description" name="description" 
                                  rows="3" maxlength="500" 
                                  placeholder="è¯·è¾“å…¥ä»»åŠ¡æè¿°ï¼ˆå¯é€‰ï¼Œæœ€å¤š500ä¸ªå­—ç¬¦ï¼‰">{{ task.description if task else description|default('') }}</textarea>
                        <div class="form-text">
                            <span id="descCount">0</span>/500 ä¸ªå­—ç¬¦
                        </div>
                    </div>
                    
                    <!-- æˆªæ­¢æ—¥æœŸ -->
                    <div class="mb-3">
                        <label for="deadline" class="form-label">æˆªæ­¢æ—¥æœŸ</label>
                        <input type="datetime-local" class="form-control" id="deadline" name="deadline" 
                               value="{{ task.deadline.strftime('%Y-%m-%dT%H:%M') if task and task.deadline else deadline|default('') }}">
                    </div>
                    
                    <!-- ä¼˜å…ˆçº§ -->
                    <div class="mb-3">
                        <label class="form-label">ä¼˜å…ˆçº§</label>
                        <div class="row g-2">
                            {% for value, label in priority_choices %}
                            <div class="col-6">
                                <input type="radio" class="btn-check" name="priority" id="priority_{{ value }}" 
                                       value="{{ value }}" 
                                       {{ 'checked' if (task and task.priority == value) or (not task and value == 'important_not_urgent') or priority == value }}>
                                <label class="btn btn-outline-secondary w-100 priority-btn priority-{{ value }}" for="priority_{{ value }}">
                                    {{ label }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- åˆ†ç±» -->
                    <div class="mb-4">
                        <label for="category_id" class="form-label">ä»»åŠ¡åˆ†ç±»</label>
                        <select class="form-select" id="category_id" name="category_id">
                            <option value="">-- æœªåˆ†ç±» --</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}" 
                                    {{ 'selected' if (task and task.category_id == category.id) or category_id == category.id }}>
                                {{ 'ğŸ“Œ ' if category.is_preset }}{{ category.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('task.task_list') }}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> å–æ¶ˆ
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> {{ 'ä¿å­˜ä¿®æ”¹' if action == 'edit' else 'åˆ›å»ºä»»åŠ¡' }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// å­—ç¬¦è®¡æ•°
document.getElementById('title').addEventListener('input', function() {
    document.getElementById('titleCount').textContent = this.value.length;
});

document.getElementById('description').addEventListener('input', function() {
    document.getElementById('descCount').textContent = this.value.length;
});

// åˆå§‹åŒ–è®¡æ•°
document.getElementById('titleCount').textContent = document.getElementById('title').value.length;
document.getElementById('descCount').textContent = document.getElementById('description').value.length;
</script>
{% endblock %}